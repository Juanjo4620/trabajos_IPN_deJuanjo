<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Productos</title>
  <link rel="stylesheet" href="../recursos/estilos.css">
  <script src="../recursos/interfaz.js" defer></script>
</head>
<body>
  <header>
    <h1>Abarrotes en Línea</h1>
    <nav>
      <a href="/abarrotes/publico/">Inicio</a>
      <a href="/abarrotes/publico/productos/listar.html">Productos</a>
      <a href="/abarrotes/publico/productos/crear.html">Crear producto</a>
      <a href="/abarrotes/publico/usuarios/registro.html">Registro</a>
      <a href="/abarrotes/publico/usuarios/inicio_sesion.html">Inicio de sesión</a>
      <span id="rolUsuario" class="badge"></span>
      <button id="btnSalir" style="display:none;">Salir</button>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h2>Productos</h2>

      <form id="formBusqueda" class="form-grid">
        <input name="q" placeholder="Buscar por nombre/categoría">
        <input name="precio_minimo" type="number" step="0.01" placeholder="Precio mín">
        <input name="precio_maximo" type="number" step="0.01" placeholder="Precio máx">
        <button>Buscar</button>
      </form>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Nombre</th><th>Precio</th><th>Existencias</th><th>Categoría</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="filas"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const cuerpo = document.getElementById('filas');
    const form = document.getElementById('formBusqueda');
    const badgeRol = document.getElementById('rolUsuario');
    const btnSalir = document.getElementById('btnSalir');

    // Mostrar rol guardado
    const rolGuardado = localStorage.getItem('rol');
    if (rolGuardado) {
      badgeRol.textContent = rolGuardado;
      btnSalir.style.display = 'inline-block';
    }

    btnSalir.addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('rol');
      location.href = '/abarrotes/publico/';
    });

    // Obtener rol actual
    function obtenerRol() {
      return localStorage.getItem('rol') || 'comprador';
    }

    async function cargar(parametros = '') {
      const r = await fetch('/abarrotes/api/productos' + parametros);
      const lista = await r.json();
      const rol = obtenerRol();

      cuerpo.innerHTML = (Array.isArray(lista) ? lista : []).map(p => `
        <tr>
          <td>${p.id}</td>
          <td>${p.nombre}</td>
          <td>${Number(p.precio).toFixed(2)}</td>
          <td>${p.existencias}</td>
          <td>${p.categoria ?? ''}</td>
          <td>
            ${rol === 'tiendero'
              ? `<a href="./editar.html?id=${p.id}" class="btn-small">Editar</a>`
              : '<span class="badge">Solo lectura</span>'}
          </td>
        </tr>
      `).join('');
    }

    cargar();

    form.addEventListener('submit', e => {
      e.preventDefault();
      const qs = new URLSearchParams(new FormData(form)).toString();
      cargar('?' + qs);
    });
  </script>
</body>
</html>
