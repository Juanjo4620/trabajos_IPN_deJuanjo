<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <title>Mis pedidos</title>
  <link rel="stylesheet" href="../recursos/estilos.css">
  <script src="../recursos/interfaz.js" defer></script>
</head>

<body>
  <header>
    <div class="container">
      <h1>Mis pedidos</h1>
      <nav>
        <div class="nav-links">
          <a href="/abarrotes/publico/">Inicio</a>
          <a href="/abarrotes/publico/productos/listar.html">Productos</a>
          <a href="/abarrotes/publico/venta.html">Venta</a>
          <a href="/abarrotes/publico/pedidos/carrito.html">Carrito</a>
          <a href="/abarrotes/publico/contacto.html">Contacto</a>

          <div class="dropdown">
            <button class="dropbtn">Usuario ‚ñæ</button>
            <div class="dropdown-menu">
              <a href="/abarrotes/publico/usuarios/registro.html">Registro</a>
              <a href="/abarrotes/publico/usuarios/inicioSesion.html">Inicio de sesi√≥n</a>
              <a href="/abarrotes/publico/pedidos/misPedidos.html">Mis pedidos</a>
              <a href="#" id="btnSalir">Salir</a>
            </div>
          </div>

          <span id="rolUsuario" class="badge"></span>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2>Historial</h2>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="filas"></tbody>
        </table>
      </div>

      <div id="sinPedidos" style="margin-top:8px; display:none;">
        <span class="badge">A√∫n no tienes pedidos.</span>
      </div>

      <div id="detalleWrap" style="margin-top:16px; display:none;">
        <h3>Detalle del pedido</h3>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio unit.</th>
                <th>Subtotal</th>
                <th>Acciones / Estado</th>
              </tr>
            </thead>
            <tbody id="detalleFilas"></tbody>
          </table>
        </div>
      </div>

      <pre id="salida" class="code-block" style="margin-top:12px;"></pre>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      configurarSesionUI('rolUsuario', 'btnSalir', '/abarrotes/publico/');
      initDropdowns();
      mostrarUsuarioEnBarra('rolUsuario');

      // üîí Proteger p√°gina y activar expiraci√≥n por inactividad (60 s)
      if (!protegerPagina()) return;

      const filas = document.getElementById('filas');
      const salida = document.getElementById('salida');
      const sinPedidos = document.getElementById('sinPedidos');
      const detalleWrap = document.getElementById('detalleWrap');
      const detalleFilas = document.getElementById('detalleFilas');

      let pedidoActualId = null; // para acciones por √≠tem

      async function cargar() {
        try {
          const r = await fetch('/abarrotes/api/pedidos', { headers: headersAutenticados() });
          const lista = await r.json();
          if (!r.ok) {
            toast((lista && (lista.mensaje || lista.error)) || 'Error cargando pedidos', 'err');
            return;
          }

          const arr = Array.isArray(lista) ? lista : [];
          if (!arr.length) {
            filas.innerHTML = '';
            sinPedidos.style.display = 'block';
            detalleWrap.style.display = 'none';
            salida.textContent = '';
            return;
          } else {
            sinPedidos.style.display = 'none';
          }

          const ultimo = localStorage.getItem('ultimo_pedido_id');

          filas.innerHTML = arr.map(p => `
            <tr data-id="${p.id}" ${ultimo && String(p.id) === ultimo ? 'style="outline:2px solid var(--accent);"' : ''}>
              <td>${p.id}</td>
              <td>$${Number(p.total).toFixed(2)}</td>
              <td>${p.estado}</td>
              <td>${p.creado_en}</td>
              <td><button class="secondary btn-ver" data-id="${p.id}">Ver</button></td>
            </tr>
          `).join('');

          if (ultimo) {
            ver(Number(ultimo));
            // Si no quieres resaltar en siguientes visitas, descomenta:
            // localStorage.removeItem('ultimo_pedido_id');
          }
        } catch {
          toast('Error de red al cargar pedidos ‚ùå', 'err');
        }
      }

      // Ver detalle de un pedido
      async function ver(id) {
        try {
          const r = await fetch('/abarrotes/api/pedidos/' + id, { headers: headersAutenticados() });
          const j = await r.json();
          salida.textContent = JSON.stringify(j, null, 2);

          if (!r.ok) {
            detalleWrap.style.display = 'none';
            toast((j && (j.mensaje || j.error)) || 'No se pudo cargar el detalle', 'err');
            return;
          }

          pedidoActualId = id;

          if (j && Array.isArray(j.items)) {
            detalleWrap.style.display = 'block';
            detalleFilas.innerHTML = j.items.map(it => {
              const estado = it.estado_item ?? 'pendiente';
              // Reglas simples para habilitar/inhabilitar acciones seg√∫n estado:
              const puedeRecibir = (estado === 'pendiente' || estado === 'enviado');
              const puedeDevolver = (['pendiente', 'enviado', 'recibido'].includes(estado));
              return `
                <tr data-detalle-id="${it.id}">
                  <td>${it.producto_nombre ?? ('#' + it.producto_id)}</td>
                  <td>${it.cantidad}</td>
                  <td>$${Number(it.precio_unitario).toFixed(2)}</td>
                  <td>$${Number(it.subtotal).toFixed(2)}</td>
                  <td>
                    <button class="btn-recibido" ${puedeRecibir ? '' : 'disabled'}>Recibido</button>
                    <button class="btn-devolucion secondary" ${puedeDevolver ? '' : 'disabled'}>Devoluci√≥n</button>
                    <span class="badge" style="margin-left:8px;">${estado}</span>
                  </td>
                </tr>
              `;
            }).join('');
          } else {
            detalleWrap.style.display = 'none';
          }

          // Resalta fila seleccionada
          document.querySelectorAll('#filas tr').forEach(tr => tr.style.outline = '');
          const trSel = document.querySelector(`#filas tr[data-id="${id}"]`);
          if (trSel) trSel.style.outline = '2px solid var(--accent)';
        } catch {
          detalleWrap.style.display = 'none';
          toast('Error de red al cargar detalle ‚ùå', 'err');
        }
      }

      // Delegaci√≥n para botones "Ver"
      filas.addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-ver');
        if (!btn) return;
        ver(Number(btn.dataset.id));
      });

      // Acciones por √≠tem: Recibido / Devoluci√≥n
      detalleFilas.addEventListener('click', async (e) => {
        const tr = e.target.closest('tr[data-detalle-id]');
        if (!tr || !pedidoActualId) return;
        const detalleId = Number(tr.dataset.detalleId);

        // Marcar como recibido
        if (e.target.classList.contains('btn-recibido')) {
          if (e.target.disabled) return;
          const ok = await confirmModal('Confirmar', '¬øMarcar este producto como recibido?');
          if (!ok) return;
          try {
            const r = await fetch(`/abarrotes/api/pedidos/${pedidoActualId}/items/${detalleId}/recibido`, {
              method: 'POST',
              headers: headersAutenticados()
            });
            const j = await r.json();
            if (r.ok) {
              toast('Producto marcado como recibido ‚úÖ', 'ok');
              ver(pedidoActualId);
            } else {
              toast(j.mensaje || 'No se pudo actualizar', 'err');
            }
          } catch {
            toast('Error de red al actualizar ‚ùå', 'err');
          }
        }

        // Solicitar devoluci√≥n
        if (e.target.classList.contains('btn-devolucion')) {
          if (e.target.disabled) return;
          const ok = await confirmModal('Devoluci√≥n', '¬øSolicitar devoluci√≥n de este producto?');
          if (!ok) return;
          try {
            const r = await fetch(`/abarrotes/api/pedidos/${pedidoActualId}/items/${detalleId}/devolucion`, {
              method: 'POST',
              headers: headersAutenticados(),
              body: JSON.stringify({ motivo: '' })
            });
            const j = await r.json();
            if (r.ok) {
              toast('Devoluci√≥n solicitada üì©', 'info');
              ver(pedidoActualId);
            } else {
              toast(j.mensaje || 'No se pudo solicitar devoluci√≥n', 'err');
            }
          } catch {
            toast('Error de red al solicitar devoluci√≥n ‚ùå', 'err');
          }
        }
      });

      // Init
      cargar();
    });
  </script>
</body>

</html>