<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Editar producto</title>
  <link rel="stylesheet" href="../recursos/estilos.css">
  <script src="../recursos/interfaz.js" defer></script>
</head>
<body>
  <header>
    <h1>Abarrotes en L√≠nea</h1>
    <nav>
      <div class="nav-links">
        <a href="/abarrotes/publico/">Inicio</a>
        <a href="/abarrotes/publico/productos/listar.html">Productos</a>
        <a href="/abarrotes/publico/venta.html">Venta</a>
        <a href="/abarrotes/publico/pedidos/carrito.html">Carrito</a>
        <a href="/abarrotes/publico/contacto.html">Contacto</a>

        <div class="dropdown">
          <button class="dropbtn">Usuario ‚ñæ</button>
          <div class="dropdown-menu">
            <a href="/abarrotes/publico/usuarios/registro.html">Registro</a>
            <a href="/abarrotes/publico/usuarios/inicioSesion.html">Inicio de sesi√≥n</a>
            <a href="/abarrotes/publico/pedidos/misPedidos.html">Mis pedidos</a>
            <a href="#" id="btnSalir">Salir</a>
          </div>
        </div>

        <span id="rolUsuario" class="badge"></span>
      </div>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h2>Editar / Eliminar producto</h2>

      <form id="formEditar" class="form-grid">
        <input type="hidden" name="id" />
        <label for="inpNombre">Nombre
          <input id="inpNombre" name="nombre" required>
        </label>
        <label for="inpDesc">Descripci√≥n
          <textarea id="inpDesc" name="descripcion"></textarea>
        </label>
        <label for="inpPrecio">Precio
          <input id="inpPrecio" name="precio" type="number" step="0.01" min="0" required>
        </label>
        <label for="inpExist">Existencias
          <input id="inpExist" name="existencias" type="number" value="0" min="0">
        </label>
        <label for="inpCat">Categor√≠a
          <input id="inpCat" name="categoria">
        </label>
        <div class="toolbar">
          <button>Guardar cambios</button>
          <button id="btnEliminar" type="button" class="secondary">Eliminar</button>
        </div>
      </form>

      <pre id="salida" class="code-block"></pre>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      configurarSesionUI('rolUsuario','btnSalir','/abarrotes/publico/');
      initDropdowns();
      mostrarUsuarioEnBarra('rolUsuario');

      // üîí Proteger p√°gina y activar inactividad (60 s)
      if (!protegerPagina()) return;

      const salida = document.getElementById('salida');
      const form = document.getElementById('formEditar');
      const id = new URLSearchParams(location.search).get('id');
      const rol = obtenerRol();

      if (!id) {
        toast('ID inv√°lido', 'err');
        setTimeout(()=>location.href='/abarrotes/publico/productos/listar.html', 900);
        return;
      }

      // üîí Solo tiendero puede editar/eliminar
      if (rol !== 'tiendero') {
        form.remove();
        document.querySelector('.card').insertAdjacentHTML(
          'beforeend',
          '<p class="badge">‚ö†Ô∏è Solo tiendero puede editar/eliminar.</p>'
        );
        return;
      }

      // Cargar datos del producto
      async function cargar() {
        try {
          const r = await fetch(`/abarrotes/api/productos/${id}`);
          const p = await r.json();
          if (r.ok && p && !p.error && !p.mensaje) {
            const mapa = { id:'id', nombre:'nombre', descripcion:'descripcion', precio:'precio', existencias:'existencias', categoria:'categoria' };
            for (const k in mapa) if (form[mapa[k]] !== undefined) form[mapa[k]].value = (p[k] ?? '');
          } else {
            toast((p && (p.mensaje||p.error)) || 'No se pudo cargar el producto', 'err');
          }
        } catch {
          toast('Error de red al cargar ‚ùå', 'err');
        }
      }
      cargar();

      // Guardar cambios
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const datos = Object.fromEntries(new FormData(form).entries());
        if (Number(datos.precio) < 0) { toast('El precio no puede ser negativo','warn'); return; }
        if (Number(datos.existencias) < 0) { toast('Las existencias no pueden ser negativas','warn'); return; }

        if (!(await confirmModal('Confirmar', '¬øGuardar los cambios del producto?'))) return;

        try {
          const r = await fetch(`/abarrotes/api/productos/${id}`, {
            method: 'PUT',
            headers: headersAutenticados(),
            body: JSON.stringify(datos)
          });
          const j = await r.json();
          salida.textContent = JSON.stringify(j, null, 2);
          if (r.ok) {
            toast('Producto actualizado ‚úÖ', 'ok');
          } else {
            toast(j.mensaje || j.error || 'Error al actualizar ‚ùå', 'err');
          }
        } catch {
          toast('Error de red al actualizar ‚ùå', 'err');
        }
      });

      // Eliminar
      document.getElementById('btnEliminar').addEventListener('click', async () => {
        if (!(await confirmModal('Confirmar', '¬øEliminar producto?'))) return;
        try {
          const r = await fetch(`/abarrotes/api/productos/${id}`, {
            method: 'DELETE',
            headers: headersAutenticados()
          });
          const j = await r.json();
          salida.textContent = JSON.stringify(j, null, 2);
          if (r.ok) {
            toast('Producto eliminado üóëÔ∏è', 'ok');
            setTimeout(()=>location.href='/abarrotes/publico/productos/listar.html', 1200);
          } else {
            toast(j.mensaje || j.error || 'Error al eliminar ‚ùå', 'err');
          }
        } catch {
          toast('Error de red al eliminar ‚ùå', 'err');
        }
      });
    });
  </script>
</body>
</html>
