<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Productos</title>
  <link rel="stylesheet" href="../recursos/estilos.css">
  <script src="../recursos/interfaz.js" defer></script>
</head>
<body>
  <header>
    <h1>Abarrotes en L칤nea</h1>
    <nav>
      <a href="/abarrotes/publico/">Inicio</a>
      <a href="/abarrotes/publico/productos/listar.html">Productos</a>
      <a href="/abarrotes/publico/productos/crear.html" id="linkCrear">Crear producto</a>
      <a href="/abarrotes/publico/pedidos/carrito.html">Carrito <span id="carritoCount" class="badge"></span></a>
      <a href="/abarrotes/publico/usuarios/registro.html">Registro</a>
      <a href="/abarrotes/publico/usuarios/inicio_sesion.html">Inicio de sesi칩n</a>
      <span id="rolUsuario" class="badge"></span>
      <button id="btnSalir" style="display:none;">Salir</button>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h2>Productos</h2>

      <form id="formBusqueda" class="form-grid">
        <input name="termino" placeholder="Buscar por nombre/categor칤a">
        <input name="precio_minimo" type="number" step="0.01" placeholder="Precio m칤n">
        <input name="precio_maximo" type="number" step="0.01" placeholder="Precio m치x">
        <button>Buscar</button>
      </form>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Nombre</th><th>Precio</th><th>Existencias</th><th>Categor칤a</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="filas"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const cuerpo = document.getElementById('filas');
    const form = document.getElementById('formBusqueda');
    const badgeRol = document.getElementById('rolUsuario');
    const btnSalir = document.getElementById('btnSalir');
    const linkCrear = document.getElementById('linkCrear');
    const carritoCount = document.getElementById('carritoCount');

    // --- Sesi칩n visual ---
    const rolGuardado = localStorage.getItem('rol');
    if (rolGuardado) {
      badgeRol.textContent = rolGuardado;
      btnSalir.style.display = 'inline-block';
    }
    // Ocultar "Crear" si no es tiendero (el backend tambi칠n valida)
    if ((rolGuardado || 'comprador') !== 'tiendero' && linkCrear) {
      linkCrear.style.display = 'none';
    }
    btnSalir.addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('rol');
      location.href = '/abarrotes/publico/';
    });

    function obtenerRol() {
      return localStorage.getItem('rol') || 'comprador';
    }

    // --- Carrito (LocalStorage) ---
    function leerCarrito() {
      try { return JSON.parse(localStorage.getItem('carrito') || '[]'); }
      catch { return []; }
    }
    function guardarCarrito(items) {
      localStorage.setItem('carrito', JSON.stringify(items));
    }
    function actualizarContadorCarrito() {
      const n = leerCarrito().reduce((acc, it) => acc + (Number(it.cantidad) || 0), 0);
      if (carritoCount) carritoCount.textContent = n > 0 ? n : '';
    }
    function agregarAlCarrito(id, nombre, precio) {
      const items = leerCarrito();
      const idx = items.findIndex(i => i.producto_id === id);
      if (idx >= 0) items[idx].cantidad += 1;
      else items.push({ producto_id: id, nombre, precio: Number(precio), cantidad: 1 });
      guardarCarrito(items);
      actualizarContadorCarrito();
      if (typeof toast === 'function') toast('Agregado al carrito 游', 'ok');
    }
    // Sincronizar contador si se modifica el carrito en otra pesta침a
    window.addEventListener('storage', (e)=>{ if (e.key === 'carrito') actualizarContadorCarrito(); });

    // --- Cargar productos ---
    async function cargar(parametros = '') {
      const r = await fetch('/abarrotes/api/productos' + parametros);
      const lista = await r.json();
      const rol = obtenerRol();

      cuerpo.innerHTML = (Array.isArray(lista) ? lista : []).map(p => `
        <tr>
          <td>${p.id}</td>
          <td>${p.nombre}</td>
          <td>${Number(p.precio).toFixed(2)}</td>
          <td>${p.existencias}</td>
          <td>${p.categoria ?? ''}</td>
          <td>
            ${
              rol === 'tiendero'
                ? `<a href="./editar.html?id=${p.id}" class="btn-small">Editar</a>`
                : `<button class="btn-small btn-agregar"
                         data-id="${p.id}"
                         data-nombre="${encodeURIComponent(p.nombre)}"
                         data-precio="${p.precio}">
                     Agregar
                   </button>`
            }
          </td>
        </tr>
      `).join('');

      actualizarContadorCarrito();
    }

    // B칰squeda: construimos qs con los nombres esperados por la API (termino, precio_minimo, precio_maximo)
    form.addEventListener('submit', e => {
      e.preventDefault();
      const qs = new URLSearchParams(new FormData(form)).toString();
      cargar('?' + qs);
    });

    // Delegaci칩n de clic para "Agregar"
    cuerpo.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-agregar');
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const nombre = decodeURIComponent(btn.dataset.nombre || '');
      const precio = Number(btn.dataset.precio);
      agregarAlCarrito(id, nombre, precio);
    });

    // Init
    cargar();
    actualizarContadorCarrito();
  </script>
</body>
</html>
