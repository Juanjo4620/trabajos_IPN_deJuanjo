<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Registro</title>
  <link rel="stylesheet" href="../recursos/estilos.css">
  <script src="../recursos/interfaz.js" defer></script>
</head>
<body>
  <header>
    <h1>Abarrotes en Línea</h1>
    <nav>
      <a href="/abarrotes/publico/">Inicio</a>
      <a href="/abarrotes/publico/productos/listar.html">Productos</a>
      <a href="/abarrotes/publico/usuarios/registro.html">Registro</a>
      <a href="/abarrotes/publico/usuarios/inicio_sesion.html">Inicio de sesión</a>
      <span id="rolUsuario" class="badge"></span>
      <button id="btnSalir" style="display:none;">Salir</button>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h2>Registro</h2>
      <form id="formRegistro" class="form-grid">
        <label>Nombre
          <input name="nombre" required>
        </label>
        <label>Correo
          <input name="correo" type="email" required>
        </label>
        <label>Contraseña
          <input name="contrasena" type="password" required>
        </label>
        <label>Rol
          <select name="rol">
            <option value="comprador" selected>Comprador</option>
            <option value="tiendero">Tiendero</option>
          </select>
        </label>
        <button>Registrarme</button>
      </form>
      <pre id="salida" class="code-block"></pre>
    </section>
  </main>

  <script>
    const form = document.getElementById('formRegistro');
    const salida = document.getElementById('salida');
    const badgeRol = document.getElementById('rolUsuario');
    const btnSalir = document.getElementById('btnSalir');

    // Mostrar rol guardado
    const rolGuardado = localStorage.getItem('rol');
    if (rolGuardado) {
      badgeRol.textContent = rolGuardado;
      btnSalir.style.display = 'inline-block';
    }

    btnSalir.addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('rol');
      location.href = '/abarrotes/publico/';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const datos = Object.fromEntries(new FormData(form).entries());

      const resp = await fetch('/abarrotes/api/usuarios/registro', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });

      const json = await resp.json();
      salida.textContent = JSON.stringify(json, null, 2);

      if (json.token) {
        localStorage.setItem('token', json.token);

        if (json.rol) {
          localStorage.setItem('rol', json.rol);
        } else {
          await refrescarPerfil();
        }

        if (typeof toast === 'function') toast('Registro exitoso ✅');
        setTimeout(() => location.href = '/abarrotes/publico/', 1500);
      } else {
        if (typeof toast === 'function') toast(json.mensaje || json.error || 'Error en registro ❌');
      }
    });

    async function refrescarPerfil() {
      const token = localStorage.getItem('token');
      if (!token) return;

      const resp = await fetch('/abarrotes/api/usuarios/perfil', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const json = await resp.json();

      // La API en español devuelve { usuario: { id, nombre, correo, rol, ... } }
      if (json.usuario && json.usuario.rol) {
        localStorage.setItem('rol', json.usuario.rol);
      }
    }
  </script>
</body>
</html>
